# 产品验真功能说明

## 📋 功能概述

**产品验真（Product Authentication）** 是一个防伪验证功能，允许消费者通过输入产品包装上的唯一验证码来验证产品的真实性。

### 功能位置
- **Header 右上角**：导航栏中的 "Verify Product" / "产品验真" 链接
- **独立页面**：`/authentication` 路由

---

## 🎯 功能目的

1. **防伪保护**：帮助消费者识别正品，防止购买假冒产品
2. **品牌保护**：保护 Sweekli 及其合作品牌的权益
3. **消费者信任**：增强消费者对产品真实性的信心
4. **数据收集**：可以追踪产品验证情况，了解市场流通情况

---

## 💻 当前前端实现

### 页面功能
- ✅ 输入验证码的表单
- ✅ 验证按钮（带加载状态）
- ✅ 验证结果显示（正品/无效）
- ✅ 再次验证功能
- ✅ 安全验证标识

### 当前状态
- ⚠️ **目前是 Mock 实现**：代码中有 `TODO` 标记，使用模拟验证逻辑
- ⚠️ **临时验证规则**：接受以 'SW' 开头的验证码作为正品（仅用于演示）

### 代码位置
```typescript
// src/views/Authentication.vue
const verifyProduct = async () => {
  // TODO: Replace with actual API call
  // 当前是模拟验证，2秒延迟后返回结果
  // 临时规则：以 'SW' 开头的验证码 = 正品
}
```

---

## 🔧 需要的后端支持

### 1. API 接口设计

#### 验证接口
```
POST /api/verify-product
或
GET /api/verify-product?code={verificationCode}
```

**请求参数：**
```json
{
  "code": "SW1234567890"  // 产品验证码
}
```

**响应格式：**
```json
// 正品
{
  "success": true,
  "authentic": true,
  "message": "该产品已验证为正品。",
  "data": {
    "code": "SW1234567890",
    "productName": "产品名称",
    "brand": "品牌名称",
    "verifiedAt": "2025-01-15T10:30:00Z",
    "firstVerified": true,  // 是否首次验证
    "verifiedCount": 1      // 验证次数
  }
}

// 无效验证码
{
  "success": false,
  "authentic": false,
  "message": "我们无法验证此产品。请检查验证码后重试。",
  "error": "INVALID_CODE"
}

// 已多次验证（可能是假货）
{
  "success": true,
  "authentic": true,
  "message": "该产品已验证为正品。",
  "warning": "此验证码已被验证多次，可能存在风险。",
  "data": {
    "code": "SW1234567890",
    "verifiedCount": 15,
    "firstVerifiedAt": "2025-01-10T08:00:00Z",
    "lastVerifiedAt": "2025-01-15T10:30:00Z"
  }
}
```

### 2. 数据库设计建议

#### 产品验证码表（product_codes）
```sql
CREATE TABLE product_codes (
  id BIGINT PRIMARY KEY AUTO_INCREMENT,
  code VARCHAR(50) UNIQUE NOT NULL,           -- 验证码（唯一）
  product_id BIGINT,                          -- 产品ID
  brand_id BIGINT,                            -- 品牌ID
  batch_number VARCHAR(50),                   -- 批次号
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  is_active BOOLEAN DEFAULT TRUE,              -- 是否有效
  INDEX idx_code (code),
  INDEX idx_product (product_id)
);
```

#### 验证记录表（verification_logs）
```sql
CREATE TABLE verification_logs (
  id BIGINT PRIMARY KEY AUTO_INCREMENT,
  code VARCHAR(50) NOT NULL,                  -- 验证码
  ip_address VARCHAR(45),                    -- 验证IP
  user_agent TEXT,                           -- 用户代理
  country VARCHAR(50),                        -- 国家（可选）
  city VARCHAR(50),                           -- 城市（可选）
  verified_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  is_first_verification BOOLEAN,              -- 是否首次验证
  INDEX idx_code (code),
  INDEX idx_verified_at (verified_at)
);
```

### 3. 后端逻辑要点

#### 验证流程
1. **接收验证码**：从请求中获取验证码
2. **验证码格式检查**：检查格式是否正确
3. **数据库查询**：查询验证码是否存在且有效
4. **验证记录**：
   - 检查是否首次验证
   - 记录验证次数
   - 记录验证IP、时间等信息
5. **返回结果**：
   - 正品：返回产品信息
   - 无效：返回错误信息
   - 多次验证：返回警告信息

#### 安全考虑
- ✅ **防暴力破解**：限制同一IP的验证频率
- ✅ **验证码加密**：验证码可以加密存储
- ✅ **防重放攻击**：可以添加时间戳验证
- ✅ **日志记录**：记录所有验证请求，用于分析

#### 业务逻辑
- **首次验证**：正常返回正品信息
- **重复验证**：
  - 可以允许（消费者可能多次验证）
  - 但需要记录次数，超过阈值可以标记为可疑
- **无效验证码**：
  - 可能是输入错误
  - 可能是假货
  - 返回友好的错误提示

---

## 📊 可选功能扩展

### 1. 地理位置检测
```typescript
// 根据IP自动判断用户所在国家/地区
// 可以用于：
// - 自动切换语言（中国用户 -> 中文）
// - 统计验证来源地区
// - 识别异常验证行为
```

### 2. 验证码生成系统
- 批量生成唯一验证码
- 与生产系统集成
- 支持二维码生成

### 3. 数据分析
- 验证次数统计
- 地区分布分析
- 异常验证检测（同一验证码多次验证）

### 4. 通知功能
- 首次验证通知品牌方
- 异常验证告警
- 验证码即将过期提醒

---

## 🚀 实施步骤

### Phase 1: 基础验证（必需）
1. ✅ 创建数据库表结构
2. ✅ 实现验证API接口
3. ✅ 前端接入真实API
4. ✅ 基础验证逻辑

### Phase 2: 安全增强（推荐）
1. ⚠️ 添加频率限制
2. ⚠️ 添加IP记录和分析
3. ⚠️ 异常检测机制

### Phase 3: 功能扩展（可选）
1. ⚠️ 地理位置检测
2. ⚠️ 数据分析面板
3. ⚠️ 通知系统

---

## 📝 前端集成示例

### 当前代码需要修改的地方

```typescript
// src/views/Authentication.vue
const verifyProduct = async () => {
  if (!code.value.trim()) return
  
  isVerifying.value = true
  result.value = null
  
  try {
    // 替换为真实API调用
    const response = await fetch('/api/verify-product', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({ code: code.value.trim() })
    })
    
    const data = await response.json()
    
    if (data.success && data.authentic) {
      result.value = 'authentic'
      // 可以显示产品信息 data.data
    } else {
      result.value = 'invalid'
    }
  } catch (error) {
    console.error('Verification failed:', error)
    result.value = 'invalid'
  } finally {
    isVerifying.value = false
  }
}
```

---

## ❓ 常见问题

### Q: 验证码格式是什么？
A: 目前前端没有限制格式，建议后端定义统一格式（如：SW + 10位数字）

### Q: 验证码在哪里生成？
A: 需要在生产/包装环节生成，可以：
- 与ERP系统集成
- 批量生成后导入数据库
- 实时生成并打印到包装上

### Q: 如何防止验证码被复制？
A: 
- 使用一次性验证码（验证后失效）
- 记录验证次数，超过阈值标记可疑
- 结合其他防伪技术（如二维码、RFID等）

### Q: 验证失败怎么办？
A: 
- 检查验证码输入是否正确
- 联系客服支持
- 提供产品照片等辅助验证

---

## 📞 联系建议

如果需要实施此功能，建议：
1. **确定验证码生成规则**：格式、长度、唯一性规则
2. **确定验证策略**：是否允许重复验证、验证次数限制
3. **确定数据需求**：需要记录哪些信息、如何分析数据
4. **确定安全要求**：频率限制、异常检测等

---

**最后更新**：2025-12-19

